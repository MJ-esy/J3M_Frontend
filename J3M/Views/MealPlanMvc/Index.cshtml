@model J3M.Models.MealPlanViewModel

<!--Page To generate Meals for a Week with shoppingList-->
@{
    ViewData["Title"] = "Weekly Meal Plan";
}

@section MetaDescription {
    <meta name="description" content="Generate personalized weekly meal plans with J3M — filter by diets and allergies, create shopping lists and get balanced menus quickly and easily." />
}

<div class="container mt-4 mealplan-container">
    <h1 class="display-4">Weekly Meal Plan</h1>

    <div class="row">
        <!-- Left column: Filters -->
        <div class="col-md-3 border-end d-flex flex-column filters-col">

            <form asp-action="GenerateWeeklyMenu" method="post" id="mealPlanForm" class="flex-grow-1 d-flex flex-column">
                <div class="flex-grow-1 overflow-auto px-1">
                    <h5>Allergies </h5>
                    @foreach (var allergy in Model.Allergies)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="AllergyIds" value="@allergy.Id"
                                   @(allergy.IsSelected ? "checked" : "") />
                            <label class="form-check-label" for="allergy@allergy.Id">@allergy.Name</label>
                        </div>
                    }

                    <h5 class="mt-3">Diets </h5>
                    @foreach (var diet in Model.Diets)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="DietIds" value="@diet.Id"
                                   @(diet.IsSelected ? "checked" : "") />
                            <label class="form-check-label" for="diet@diet.Id">@diet.Name</label>
                        </div>
                    }
                </div>

                <!-- Pinned button -->
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary w-100">Generate Weekly Menu</button>
                </div>
            </form>

            <!-- Error + Spinner -->
            <div id="errorMessage" class="alert alert-danger mt-3" style="display:none;">
                Something went wrong. Please try again.
            </div>
            <div id="loadingSpinner" class="text-center mt-3" style="display:none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Right column: Results -->
        <div class="col-md-9">
            <div id="mealPlanContent">
                @* Initial state: show info if no plan *@
                @if (Model.WeeklyPlan == null)
                {
                    <div class="alert alert-info mt-4">
                        No meal plan generated yet. <br/>
                        Select allergies/diets and click <strong>Generate Weekly Menu</strong>.
                    </div>
                }
                else
                {
                    @await Html.PartialAsync("_MealPlanPartial", Model)
                }
            </div>
        </div>
    </div>
</div>

<script>
    $("#mealPlanForm").submit(function (e) {
        e.preventDefault();
        $("#loadingSpinner").show();
        $("#errorMessage").hide();

        $.ajax({
            url: $(this).attr("action"),
            type: "POST",
            data: $(this).serialize(),
            success: function (result) {
                $("#mealPlanContent").html(result);
                $("#loadingSpinner").hide();
            },
            error: function (xhr) {
                $("#errorMessage").show();
                $("#loadingSpinner").hide();
                console.error("Error:", xhr.responseText);
            }
        });
    });

    // Download Shopping List
    function downloadShoppingList() {
        const items = [];
        $("#mealPlanContent .list-group-item").each(function () {
            items.push($(this).text());
        });

        if (items.length === 0) {
            alert("No shopping list available.");
            return;
        }

        const blob = new Blob([items.join("\n")], { type: "text/plain" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "ShoppingList.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
